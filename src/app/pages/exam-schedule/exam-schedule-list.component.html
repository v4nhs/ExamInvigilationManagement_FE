<div class="schedule-list-container">
  <div class="page-header">
    <h2>L·ªãch thi</h2>
    <div class="header-actions">
      <button class="add-btn" (click)="openAddForm()" *ngIf="isAdmin()">+ Th√™m l·ªãch thi</button>
      <button class="import-btn" (click)="fileInput.click()" *ngIf="isAdmin()">‚¨Ü Import t·ª´ file</button>
      <input type="file" #fileInput hidden accept=".xlsx,.xls" (change)="onFileSelected($event)" />
    </div>
  </div>

  <div class="search-filter-section">
    <div class="search-box">
      <i class="search-icon">üîç</i>
      <input 
        type="text" 
        placeholder="T√¨m ki·∫øm theo t√™n HP, m√£ HP, ph√≤ng, ng√†y..."
        [(ngModel)]="searchQuery"
        (input)="onSearchChange()"
        class="search-input"
      />
      <button *ngIf="searchQuery" class="clear-btn" (click)="clearSearch()">‚úï</button>
    </div>

    <div class="sort-controls">
      <label for="sortBy">S·∫Øp x·∫øp theo:</label>
      <select [(ngModel)]="sortBy" (change)="onSortChange()" id="sortBy" class="sort-select">
        <option value="examDate">Ng√†y thi</option>
        <option value="courseName">T√™n HP</option>
      </select>

      <select [(ngModel)]="sortDirection" (change)="onSortChange()" class="sort-select">
        <option value="DESC">M·ªõi nh·∫•t</option>
        <option value="ASC">C≈© nh·∫•t</option>
      </select>
    </div>
  </div>

  <div class="table-responsive">
    <table class="schedule-table" *ngIf="filteredSchedules.length > 0; else emptyBlock">
      <thead>
        <tr>
          <th>#</th>
          <th>M√£ HP</th>
          <th>T√™n HP</th>
          <th>Th·ª©</th>
          <th>Ng√†y thi</th>
          <th>Gi·ªù thi</th>
          <th>Gi·ªù k·∫øt th√∫c</th>
          <th>H√¨nh th·ª©c thi</th>
          <th>S·ªë c√°n b·ªô coi thi</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let schedule of filteredSchedules; let i = index">
          <td>{{ currentPage * pageSize + i + 1 }}</td>
          <td>{{ schedule.courseCode }}</td>
          <td class="course-name">{{ schedule.courseName }}</td>
          <td>{{ schedule.examDay }}</td>
          <td>{{ schedule.examDate }}</td>
          <td>{{ schedule.examTime }}</td>
          <td>{{ schedule.endTime }}</td>
          <td>
            <span class="exam-type-badge" [ngClass]="'type-' + schedule.examType.toLowerCase()">
              {{ schedule.examType === 'WRITTEN' ? 'Thi vi·∫øt' : 'H√¨nh th·ª©c kh√°c' }}
            </span>
          </td>
          <td class="text-center">{{ schedule.invigilatorCount }}</td>
          <td>
            <button class="action-btn view-lecturers-btn" (click)="viewAssignedLecturers(schedule.id)" *ngIf="isAdmin()">
              Xem gi·∫£ng vi√™n
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <ng-template #emptyBlock>
      <div class="no-data">
        <table class="schedule-table">
          <thead>
            <tr>
              <th>#</th>
              <th>M√£ HP</th>
              <th>T√™n HP</th>
              <th>Th·ª©</th>
              <th>Ng√†y thi</th>
              <th>Gi·ªù thi</th>
              <th>Gi·ªù k·∫øt th√∫c</th>
              <th>H√¨nh th·ª©c thi</th>
              <th>S·ªë c√°n b·ªô coi thi</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="10" class="text-center">Kh√¥ng c√≥ l·ªãch thi n√†o</td>
            </tr>
          </tbody>
        </table>
      </div>
    </ng-template>
  </div>

  <div *ngIf="loading" class="loading">ƒêang t·∫£i...</div>

  <!-- Pagination Controls -->
  <div class="pagination-container" *ngIf="totalPages > 1 || totalElements > 0">
    <div class="pagination-header">
      <div class="pagination-info">
        Hi·ªÉn th·ªã {{ currentPage * pageSize + 1 }} ƒë·∫øn {{ Math.min((currentPage + 1) * pageSize, totalElements) }} 
        tr√™n t·ªïng s·ªë {{ totalElements }} l·ªãch thi
      </div>
      
      <div class="page-size-selector">
        <label for="pageSize">Hi·ªÉn th·ªã:</label>
        <select 
          id="pageSize"
          [(ngModel)]="pageSize" 
          (change)="onPageSizeChange()"
          class="page-size-select">
          <option *ngFor="let size of pageSizeOptions" [value]="size">
            {{ size }} m·ª•c
          </option>
        </select>
      </div>
    </div>
    
    <div class="pagination-controls" *ngIf="totalPages > 1">
      <button 
        class="page-btn" 
        (click)="previousPage()" 
        [disabled]="currentPage === 0">
        ‚Üê Tr∆∞·ªõc
      </button>

      <button 
        *ngFor="let page of getPageNumbers()"
        class="page-btn"
        [class.active]="page === currentPage"
        (click)="goToPage(page)">
        {{ page + 1 }}
      </button>

      <button 
        class="page-btn" 
        (click)="nextPage()" 
        [disabled]="currentPage === totalPages - 1">
        Ti·∫øp ‚Üí 
      </button>
    </div>
  </div>

  <!-- Import Dialog -->
  <div *ngIf="showImportDialog" class="import-dialog-overlay">
    <div class="import-dialog">
      <div class="dialog-header">
        <h3>Nh·∫≠p l·ªãch thi t·ª´ file</h3>
      </div>
      <div class="dialog-body">
        <div class="form-group">
          <label for="department-select">Ch·ªçn khoa:</label>
          <select id="department-select" [(ngModel)]="selectedDepartmentId" class="department-select">
            <option [value]="null" disabled>-- Vui l√≤ng ch·ªçn khoa --</option>
            <option *ngFor="let dept of departments" [value]="dept.id">{{ dept.name }}</option>
          </select>
        </div>
        <div class="file-info">
          <p><strong>File:</strong> {{ importFile?.name }}</p>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="cancel-btn" (click)="closeImportDialog()" [disabled]="importing">H·ªßy</button>
        <button class="confirm-btn" (click)="confirmImport()" [disabled]="importing">
          {{ importing ? 'ƒêang import...' : 'Import' }}
        </button>
      </div>
    </div>
  </div>

  <app-exam-schedule-form 
    *ngIf="showAddForm"
    (close)="closeAddForm()"
    (saved)="onScheduleSaved()">
  </app-exam-schedule-form>

  <!-- Lecturer Modal -->
  <div *ngIf="showLecturerModal" class="lecturer-modal-overlay" (click)="closeLecturerModal()">
    <div class="lecturer-modal" (click)="$event.stopPropagation()">
      <div class="lecturer-modal-header">
        <h3>Gi·∫£ng vi√™n coi thi</h3>
        <button class="close-btn" (click)="closeLecturerModal()">‚úï</button>
      </div>
      
      <div class="lecturer-modal-body">
        <div class="schedule-info" *ngIf="selectedScheduleForLecturers">
          <h4>L·ªãch thi: {{ selectedScheduleForLecturers.courseName }}</h4>
          <p><strong>M√£ HP:</strong> {{ selectedScheduleForLecturers.courseCode }}</p>
          <p><strong>Ng√†y thi:</strong> {{ selectedScheduleForLecturers.examDate }} ({{ selectedScheduleForLecturers.examDay }})</p>
          <p><strong>Gi·ªù thi:</strong> {{ selectedScheduleForLecturers.examTime }} - {{ selectedScheduleForLecturers.endTime }}</p>
        </div>

        <div class="lecturers-section" *ngIf="lecturerList.length > 0">
          <h4>Danh s√°ch gi·∫£ng vi√™n ({{ lecturerList.length }})</h4>
          <table class="lecturer-table">
            <thead>
              <tr>
                <th>#</th>
                <th>T√™n gi·∫£ng vi√™n</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let lecturer of lecturerList; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ lecturer.lecturerName || lecturer.fullName || 'N/A' }}</td>
                <td>{{ lecturer.email || 'N/A' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="no-lecturers" *ngIf="lecturerList.length === 0">
          <p>Ch∆∞a c√≥ gi·∫£ng vi√™n ƒë∆∞·ª£c ph√¢n c√¥ng cho l·ªãch thi n√†y.</p>
        </div>
      </div>

      <div class="lecturer-modal-footer">
        <button class="close-modal-btn" (click)="closeLecturerModal()">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>
